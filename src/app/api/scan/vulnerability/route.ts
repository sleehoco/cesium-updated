import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { generateCompletion } from '@/lib/ai/completions';
import { SECURITY_PROMPTS } from '@/lib/ai/prompts';
import { rateLimit, RATE_LIMITS } from '@/lib/rate-limit';

/**
 * Vulnerability Scan API
 * Analyzes targets for security vulnerabilities using AI
 */

const vulnerabilityScanSchema = z.object({
  target: z.string().min(1, 'Target is required').max(2000, 'Target too large'),
  scanType: z.enum(['network', 'web', 'code', 'config', 'general']),
  description: z.string().max(5000, 'Description too large').optional(),
});

export async function POST(req: NextRequest) {
  // Rate limiting
  const rateLimitResult = rateLimit(req, RATE_LIMITS.AI_ENDPOINT);

  if (!rateLimitResult.success) {
    return NextResponse.json(
      { error: 'Too many requests. Please try again later.' },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': rateLimitResult.limit.toString(),
          'X-RateLimit-Remaining': rateLimitResult.remaining.toString(),
          'X-RateLimit-Reset': rateLimitResult.reset.toString(),
          'Retry-After': Math.ceil(
            (rateLimitResult.reset * 1000 - Date.now()) / 1000
          ).toString(),
        },
      }
    );
  }


  try {
    const body = await req.json();
    const { target, scanType, description } = vulnerabilityScanSchema.parse(body);

    // Build the analysis prompt
    const userMessage = `
Analyze the following target for security vulnerabilities:

**Target**: ${target}
**Scan Type**: ${scanType}
${description ? `**Additional Context**: ${description}` : ''}

Provide a comprehensive vulnerability assessment including:
1. Identified vulnerabilities or potential security weaknesses
2. Risk assessment for each finding
3. Exploitability analysis
4. Business impact
5. Detailed remediation steps
6. Workarounds if immediate patching isn't possible
7. Compliance implications (if applicable)

If this is a theoretical analysis or you need additional information to provide specific vulnerabilities, explain what additional data would be needed for a complete assessment and provide general security recommendations for this type of target.
`.trim();

    // Generate AI analysis
    const analysis = await generateCompletion({
      systemPrompt: SECURITY_PROMPTS.VULNERABILITY_ANALYZER,
      userMessage,
      provider: 'groq',
      temperature: 0.3,
    });

    return NextResponse.json({
      success: true,
      data: {
        target,
        scanType,
        analysis,
        timestamp: new Date().toISOString(),
      },
    });
  } catch (error) {
    // Validation error
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        {
          error: 'Invalid request data',
          details: error.errors,
        },
        { status: 400 }
      );
    }

    // AI generation error
    if (error instanceof Error && error.message.includes('timed out')) {
      return NextResponse.json(
        {
          error: 'Request timed out. Please try again with a smaller target.',
        },
        { status: 504 }
      );
    }

    // Generic error
    console.error('Vulnerability scan error:', error);
    return NextResponse.json(
      {
        error: 'Failed to analyze vulnerability. Please try again.',
      },
      { status: 500 }
    );
  }
}

// OPTIONS handler removed - CORS not needed for authenticated same-origin requests
